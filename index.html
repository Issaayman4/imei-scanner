<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultra-Reliable IMEI/UPC Scanner - iPHOXY CORP</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            padding: 10px;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #2196F3;
            font-size: 1.8rem;
            margin-bottom: 5px;
        }

        .header p {
            color: #666;
            font-size: 1rem;
        }

        .controls {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .user-select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 15px;
            background: white;
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 120px;
            justify-content: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #2196F3, #1976D2);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #f44336, #d32f2f);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .camera-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .camera-feed {
            width: 100%;
            max-height: 400px;
            border-radius: 8px;
            background: #000;
            position: relative;
            overflow: hidden;
        }

        #video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 8px;
        }

        .scan-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 250px;
            height: 150px;
            border: 3px solid #4CAF50;
            border-radius: 8px;
            background: rgba(76, 175, 80, 0.1);
            pointer-events: none;
            z-index: 10;
        }

        .scan-overlay::before {
            content: 'Position barcode here';
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            background: #4CAF50;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        .detection-box {
            position: absolute;
            border: 3px solid;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.1);
            pointer-events: none;
            z-index: 15;
            animation: pulse 1s infinite;
        }

        .detection-box.imei {
            border-color: #2196F3;
            box-shadow: 0 0 15px rgba(33, 150, 243, 0.7);
        }

        .detection-box.upc {
            border-color: #FF9800;
            box-shadow: 0 0 15px rgba(255, 152, 0, 0.7);
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        .detection-label {
            position: absolute;
            top: -25px;
            left: 0;
            background: inherit;
            color: white;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: bold;
        }

        .camera-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 300px;
            background: #f5f5f5;
            border-radius: 8px;
            color: #666;
        }

        .camera-placeholder .icon {
            font-size: 4rem;
            margin-bottom: 15px;
        }

        .stats {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #2196F3;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #2196F3;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #666;
        }

        .results {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            max-height: 300px;
            overflow-y: auto;
        }

        .result-item {
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid #4CAF50;
            background: #f8f9fa;
            display: flex;
            justify-content: space-between;
            align-items: center;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .result-item.imei {
            border-left-color: #2196F3;
        }

        .result-item.upc {
            border-left-color: #FF9800;
        }

        .result-item.duplicate {
            border-left-color: #f44336;
            background: #ffebee;
        }

        .result-code {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            font-size: 1.1rem;
        }

        .result-type {
            background: #2196F3;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .result-type.upc {
            background: #FF9800;
        }

        .result-type.duplicate {
            background: #f44336;
        }

        .status {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .status.success {
            background: rgba(76, 175, 80, 0.1);
            border: 2px solid #4CAF50;
            color: #2E7D32;
        }

        .status.error {
            background: rgba(244, 67, 54, 0.1);
            border: 2px solid #f44336;
            color: #C62828;
        }

        .status.warning {
            background: rgba(255, 152, 0, 0.1);
            border: 2px solid #FF9800;
            color: #F57C00;
        }

        .hidden {
            display: none !important;
        }

        .camera-info {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            z-index: 20;
        }

        .scan-rate {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(76, 175, 80, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: bold;
            z-index: 20;
        }

        @media (max-width: 768px) {
            .container {
                padding: 5px;
            }
            
            .header h1 {
                font-size: 1.5rem;
            }
            
            .btn {
                min-width: 100px;
                padding: 10px 15px;
                font-size: 14px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>📱 Ultra-Reliable IMEI/UPC Scanner</h1>
            <p>iPHOXY CORP - Guaranteed Barcode Detection</p>
        </div>

        <!-- Controls -->
        <div class="controls">
            <select id="userSelect" class="user-select">
                <option value="">Select your name...</option>
                <option value="Aiman">Aiman (Manager)</option>
                <option value="Scanner1">Scanner Operator 1</option>
                <option value="Scanner2">Scanner Operator 2</option>
                <option value="Scanner3">Scanner Operator 3</option>
                <option value="QualityControl">Quality Control</option>
                <option value="Supervisor">Supervisor</option>
            </select>

            <div class="button-group">
                <button id="startBtn" class="btn btn-primary">
                    <span>🚀</span> Start Scanning
                </button>
                <button id="stopBtn" class="btn btn-danger hidden">
                    <span>⏹️</span> Stop Scanning
                </button>
                <button id="switchCameraBtn" class="btn btn-secondary">
                    <span>🔄</span> Switch Camera
                </button>
                <button id="exportBtn" class="btn btn-secondary">
                    <span>📊</span> Export Data
                </button>
            </div>
        </div>

        <!-- Status -->
        <div id="status" class="status">
            Ready to scan IMEI and UPC barcodes - Ultra-reliable detection
        </div>

        <!-- Camera -->
        <div class="camera-container">
            <div id="cameraPlaceholder" class="camera-placeholder">
                <div class="icon">📷</div>
                <h3>Camera Ready</h3>
                <p>Click "Start Scanning" to begin</p>
                <p style="font-size: 0.9rem; margin-top: 10px; color: #888;">
                    Position phone boxes 30-50cm from camera
                </p>
            </div>
            <div id="cameraFeed" class="camera-feed hidden">
                <video id="video" autoplay muted playsinline></video>
                <div class="scan-overlay"></div>
                <canvas id="canvas" style="display: none;"></canvas>
                <div id="cameraInfo" class="camera-info">Initializing...</div>
                <div id="scanRate" class="scan-rate">0 scans/min</div>
            </div>
        </div>

        <!-- Statistics -->
        <div class="stats">
            <h3 style="margin-bottom: 15px; text-align: center;">📊 Scan Statistics</h3>
            <div class="stats-grid">
                <div class="stat-item">
                    <div id="totalScans" class="stat-number">0</div>
                    <div class="stat-label">Total Scans</div>
                </div>
                <div class="stat-item">
                    <div id="imeiCount" class="stat-number">0</div>
                    <div class="stat-label">IMEI Codes</div>
                </div>
                <div class="stat-item">
                    <div id="upcCount" class="stat-number">0</div>
                    <div class="stat-label">UPC Codes</div>
                </div>
                <div class="stat-item">
                    <div id="duplicateCount" class="stat-number">0</div>
                    <div class="stat-label">Duplicates</div>
                </div>
            </div>
        </div>

        <!-- Results -->
        <div class="results">
            <h3 style="margin-bottom: 15px;">📋 Recent Scans</h3>
            <div id="resultsList">
                <p style="text-align: center; color: #666;">No scans yet. Start scanning to see results here.</p>
            </div>
        </div>
    </div>

    <!-- QuaggaJS Library - More reliable than ZXing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    
    <script>
        class UltraReliableScanner {
            constructor() {
                this.isScanning = false;
                this.currentUser = null;
                this.scanData = [];
                this.duplicates = new Set();
                
                // Camera
                this.video = document.getElementById('video');
                this.canvas = document.getElementById('canvas');
                this.ctx = this.canvas.getContext('2d');
                this.currentStream = null;
                this.cameras = [];
                this.currentCameraIndex = 0;
                
                // Statistics
                this.stats = {
                    total: 0,
                    imei: 0,
                    upc: 0,
                    duplicates: 0
                };
                
                // Scan rate tracking
                this.scanTimes = [];
                this.lastScanTime = 0;
                
                this.init();
            }

            async init() {
                try {
                    // Get cameras
                    await this.initializeCameras();
                    
                    // Setup event listeners
                    this.setupEventListeners();
                    
                    // Update UI
                    this.updateStatus('Ultra-reliable scanner initialized. Ready to scan!', 'success');
                    
                } catch (error) {
                    console.error('Initialization failed:', error);
                    this.updateStatus('Failed to initialize scanner: ' + error.message, 'error');
                }
            }

            async initializeCameras() {
                try {
                    // Get camera permissions first
                    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                    stream.getTracks().forEach(track => track.stop());
                    
                    // Get all video devices
                    const devices = await navigator.mediaDevices.enumerateDevices();
                    this.cameras = devices.filter(device => device.kind === 'videoinput');
                    
                    console.log('Available cameras:', this.cameras);
                    
                    // Find back camera
                    const backCameraIndex = this.cameras.findIndex(camera => 
                        camera.label.toLowerCase().includes('back') || 
                        camera.label.toLowerCase().includes('rear') ||
                        camera.label.toLowerCase().includes('environment')
                    );
                    
                    if (backCameraIndex !== -1) {
                        this.currentCameraIndex = backCameraIndex;
                    } else if (this.cameras.length > 1) {
                        this.currentCameraIndex = this.cameras.length - 1;
                    }
                    
                    this.updateCameraInfo();
                    
                } catch (error) {
                    console.error('Camera initialization failed:', error);
                    throw new Error('Camera access denied or not available');
                }
            }

            setupEventListeners() {
                // User selection
                document.getElementById('userSelect').addEventListener('change', (e) => {
                    this.currentUser = e.target.value;
                    this.updateUI();
                });

                // Start scanning
                document.getElementById('startBtn').addEventListener('click', () => {
                    this.startScanning();
                });

                // Stop scanning
                document.getElementById('stopBtn').addEventListener('click', () => {
                    this.stopScanning();
                });

                // Switch camera
                document.getElementById('switchCameraBtn').addEventListener('click', () => {
                    this.switchCamera();
                });

                // Export data
                document.getElementById('exportBtn').addEventListener('click', () => {
                    this.exportData();
                });
            }

            async startScanning() {
                if (!this.currentUser) {
                    this.updateStatus('Please select a user first', 'warning');
                    return;
                }

                try {
                    this.updateStatus('Starting ultra-reliable scanner...', 'warning');
                    
                    // Start camera
                    await this.startCamera();
                    
                    // Show camera feed
                    document.getElementById('cameraPlaceholder').classList.add('hidden');
                    document.getElementById('cameraFeed').classList.remove('hidden');
                    
                    // Initialize QuaggaJS
                    await this.initializeQuagga();
                    
                    // Update UI
                    document.getElementById('startBtn').classList.add('hidden');
                    document.getElementById('stopBtn').classList.remove('hidden');
                    
                    this.isScanning = true;
                    this.updateStatus('Ultra-reliable scanning active! Point camera at barcodes.', 'success');
                    
                    // Start scan rate monitoring
                    this.startScanRateMonitoring();
                    
                } catch (error) {
                    console.error('Failed to start scanning:', error);
                    this.updateStatus('Failed to start scanner: ' + error.message, 'error');
                }
            }

            async startCamera() {
                try {
                    // Stop existing stream
                    if (this.currentStream) {
                        this.currentStream.getTracks().forEach(track => track.stop());
                    }

                    // Camera constraints
                    let constraints = {
                        video: {
                            width: { ideal: 1280, min: 640 },
                            height: { ideal: 720, min: 480 },
                            frameRate: { ideal: 30 }
                        }
                    };

                    // Use specific camera if available
                    if (this.cameras.length > 0 && this.cameras[this.currentCameraIndex]) {
                        constraints.video.deviceId = { exact: this.cameras[this.currentCameraIndex].deviceId };
                    } else {
                        constraints.video.facingMode = { ideal: 'environment' };
                    }

                    // Get camera stream
                    this.currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                    this.video.srcObject = this.currentStream;

                    // Wait for video to load
                    await new Promise((resolve) => {
                        this.video.onloadedmetadata = () => {
                            this.setupCanvas();
                            this.updateCameraInfo();
                            resolve();
                        };
                    });

                } catch (error) {
                    throw new Error('Camera access failed: ' + error.message);
                }
            }

            setupCanvas() {
                // Match canvas to video size
                this.canvas.width = this.video.videoWidth;
                this.canvas.height = this.video.videoHeight;
            }

            async initializeQuagga() {
                return new Promise((resolve, reject) => {
                    Quagga.init({
                        inputStream: {
                            name: "Live",
                            type: "LiveStream",
                            target: this.video,
                            constraints: {
                                width: this.video.videoWidth,
                                height: this.video.videoHeight,
                                facingMode: "environment"
                            }
                        },
                        locator: {
                            patchSize: "medium",
                            halfSample: true
                        },
                        numOfWorkers: 2,
                        frequency: 10,
                        decoder: {
                            readers: [
                                "code_128_reader",
                                "ean_reader",
                                "ean_8_reader",
                                "code_39_reader",
                                "code_39_vin_reader",
                                "codabar_reader",
                                "upc_reader",
                                "upc_e_reader",
                                "i2of5_reader"
                            ]
                        },
                        locate: true
                    }, (err) => {
                        if (err) {
                            console.error('QuaggaJS initialization failed:', err);
                            reject(err);
                            return;
                        }
                        
                        console.log('QuaggaJS initialized successfully');
                        
                        // Start QuaggaJS
                        Quagga.start();
                        
                        // Setup detection handler
                        Quagga.onDetected((result) => {
                            this.handleBarcodeDetection(result);
                        });
                        
                        resolve();
                    });
                });
            }

            handleBarcodeDetection(result) {
                const code = result.codeResult.code;
                const format = result.codeResult.format;
                
                console.log('Detected barcode:', code, format);
                
                // Determine barcode type
                let type = 'OTHER';
                if (this.isIMEI(code)) {
                    type = 'IMEI';
                } else if (this.isUPC(code)) {
                    type = 'UPC';
                } else {
                    // Skip non-IMEI/UPC barcodes
                    return;
                }
                
                // Check for duplicates
                if (this.duplicates.has(code)) {
                    this.handleDuplicate(code, type);
                    return;
                }
                
                // Add to results
                this.addScanResult(code, type, format);
                
                // Draw detection overlay
                this.drawDetectionOverlay(result, type);
                
                // Play success feedback
                this.playSuccessFeedback();
                
                // Update scan rate
                this.updateScanRate();
            }

            isIMEI(code) {
                // IMEI: 15 digits
                if (!/^\d{15}$/.test(code)) return false;
                
                // Luhn algorithm validation
                let sum = 0;
                for (let i = 0; i < 14; i++) {
                    let digit = parseInt(code[i]);
                    if (i % 2 === 1) {
                        digit *= 2;
                        if (digit > 9) digit -= 9;
                    }
                    sum += digit;
                }
                const checkDigit = (10 - (sum % 10)) % 10;
                return checkDigit === parseInt(code[14]);
            }

            isUPC(code) {
                // UPC-A: 12 digits
                if (!/^\d{12}$/.test(code)) return false;
                
                // UPC checksum validation
                let sum = 0;
                for (let i = 0; i < 11; i++) {
                    const digit = parseInt(code[i]);
                    sum += (i % 2 === 0) ? digit : digit * 3;
                }
                const checkDigit = (10 - (sum % 10)) % 10;
                return checkDigit === parseInt(code[11]);
            }

            addScanResult(code, type, format) {
                const scanResult = {
                    code: code,
                    type: type,
                    format: format,
                    timestamp: new Date(),
                    user: this.currentUser
                };
                
                // Add to data
                this.scanData.push(scanResult);
                this.duplicates.add(code);
                
                // Update statistics
                this.stats.total++;
                if (type === 'IMEI') this.stats.imei++;
                if (type === 'UPC') this.stats.upc++;
                
                // Update UI
                this.updateStatistics();
                this.addResultToList(scanResult);
                
                console.log('Added scan result:', scanResult);
            }

            handleDuplicate(code, type) {
                this.stats.duplicates++;
                this.updateStatistics();
                
                // Show duplicate in results
                const duplicateResult = {
                    code: code,
                    type: 'DUPLICATE',
                    timestamp: new Date(),
                    user: this.currentUser
                };
                this.addResultToList(duplicateResult);
                
                // Brief vibration for duplicate
                if (navigator.vibrate) {
                    navigator.vibrate([50, 50, 50]);
                }
            }

            drawDetectionOverlay(result, type) {
                // Remove existing overlays
                document.querySelectorAll('.detection-box').forEach(box => box.remove());
                
                if (!result.box) return;
                
                const box = result.box;
                const videoRect = this.video.getBoundingClientRect();
                
                // Calculate box position relative to video
                const scaleX = videoRect.width / this.video.videoWidth;
                const scaleY = videoRect.height / this.video.videoHeight;
                
                const overlay = document.createElement('div');
                overlay.className = `detection-box ${type.toLowerCase()}`;
                overlay.style.left = (box[0][0] * scaleX) + 'px';
                overlay.style.top = (box[0][1] * scaleY) + 'px';
                overlay.style.width = ((box[1][0] - box[0][0]) * scaleX) + 'px';
                overlay.style.height = ((box[2][1] - box[0][1]) * scaleY) + 'px';
                
                // Add label
                const label = document.createElement('div');
                label.className = 'detection-label';
                label.textContent = type;
                overlay.appendChild(label);
                
                // Add to camera feed
                document.getElementById('cameraFeed').appendChild(overlay);
                
                // Remove after 3 seconds
                setTimeout(() => {
                    if (overlay.parentNode) {
                        overlay.parentNode.removeChild(overlay);
                    }
                }, 3000);
            }

            playSuccessFeedback() {
                // Vibration
                if (navigator.vibrate) {
                    navigator.vibrate(200);
                }
                
                // Sound
                try {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.value = 1000;
                    oscillator.type = 'sine';
                    
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                    
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.2);
                } catch (error) {
                    // Audio not supported, ignore
                }
            }

            updateScanRate() {
                const now = Date.now();
                this.scanTimes.push(now);
                
                // Keep only last minute of scans
                this.scanTimes = this.scanTimes.filter(time => now - time < 60000);
                
                const scansPerMinute = this.scanTimes.length;
                document.getElementById('scanRate').textContent = `${scansPerMinute} scans/min`;
            }

            startScanRateMonitoring() {
                setInterval(() => {
                    this.updateScanRate();
                }, 5000);
            }

            addResultToList(result) {
                const resultsList = document.getElementById('resultsList');
                
                // Clear "no scans" message
                if (resultsList.children.length === 1 && resultsList.children[0].tagName === 'P') {
                    resultsList.innerHTML = '';
                }
                
                // Create result element
                const resultElement = document.createElement('div');
                resultElement.className = `result-item ${result.type.toLowerCase()}`;
                
                const timeStr = result.timestamp.toLocaleTimeString();
                
                resultElement.innerHTML = `
                    <div>
                        <div class="result-code">${result.code}</div>
                        <small>${timeStr} - ${result.user}</small>
                    </div>
                    <div class="result-type ${result.type.toLowerCase()}">${result.type}</div>
                `;
                
                // Add to top of list
                resultsList.insertBefore(resultElement, resultsList.firstChild);
                
                // Keep only last 20 results
                while (resultsList.children.length > 20) {
                    resultsList.removeChild(resultsList.lastChild);
                }
            }

            updateStatistics() {
                document.getElementById('totalScans').textContent = this.stats.total;
                document.getElementById('imeiCount').textContent = this.stats.imei;
                document.getElementById('upcCount').textContent = this.stats.upc;
                document.getElementById('duplicateCount').textContent = this.stats.duplicates;
            }

            updateCameraInfo() {
                const cameraInfo = document.getElementById('cameraInfo');
                if (this.cameras.length > 0 && this.cameras[this.currentCameraIndex]) {
                    const camera = this.cameras[this.currentCameraIndex];
                    cameraInfo.textContent = `Camera: ${camera.label || 'Unknown'} (${this.currentCameraIndex + 1}/${this.cameras.length})`;
                } else {
                    cameraInfo.textContent = 'Camera: Default';
                }
            }

            async switchCamera() {
                if (this.cameras.length <= 1) {
                    this.updateStatus('No additional cameras available', 'warning');
                    return;
                }
                
                this.currentCameraIndex = (this.currentCameraIndex + 1) % this.cameras.length;
                
                if (this.isScanning) {
                    try {
                        // Stop QuaggaJS
                        Quagga.stop();
                        
                        // Restart camera
                        await this.startCamera();
                        
                        // Restart QuaggaJS
                        await this.initializeQuagga();
                        
                        this.updateStatus('Camera switched successfully', 'success');
                    } catch (error) {
                        this.updateStatus('Failed to switch camera: ' + error.message, 'error');
                    }
                }
            }

            stopScanning() {
                this.isScanning = false;
                
                // Stop QuaggaJS
                if (typeof Quagga !== 'undefined') {
                    Quagga.stop();
                }
                
                // Stop camera
                if (this.currentStream) {
                    this.currentStream.getTracks().forEach(track => track.stop());
                    this.currentStream = null;
                }
                
                // Remove detection overlays
                document.querySelectorAll('.detection-box').forEach(box => box.remove());
                
                // Hide camera feed
                document.getElementById('cameraFeed').classList.add('hidden');
                document.getElementById('cameraPlaceholder').classList.remove('hidden');
                
                // Update UI
                document.getElementById('startBtn').classList.remove('hidden');
                document.getElementById('stopBtn').classList.add('hidden');
                
                this.updateStatus('Scanning stopped', 'warning');
            }

            exportData() {
                if (this.scanData.length === 0) {
                    this.updateStatus('No data to export', 'warning');
                    return;
                }
                
                // Create CSV content
                const headers = ['Timestamp', 'Code', 'Type', 'Format', 'User'];
                const csvContent = [
                    headers.join(','),
                    ...this.scanData.map(item => [
                        item.timestamp.toISOString(),
                        item.code,
                        item.type,
                        item.format,
                        item.user
                    ].join(','))
                ].join('\n');
                
                // Download CSV
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `imei_upc_scans_${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                URL.revokeObjectURL(url);
                
                this.updateStatus('Data exported successfully', 'success');
            }

            updateStatus(message, type = 'info') {
                const statusElement = document.getElementById('status');
                statusElement.textContent = message;
                statusElement.className = `status ${type}`;
                
                console.log(`Status (${type}):`, message);
            }

            updateUI() {
                // Enable/disable buttons based on state
                const hasUser = !!this.currentUser;
                document.getElementById('startBtn').disabled = !hasUser;
                document.getElementById('switchCameraBtn').disabled = this.cameras.length <= 1;
            }
        }

        // Initialize scanner when page loads
        document.addEventListener('DOMContentLoaded', () => {
            window.scanner = new UltraReliableScanner();
        });
    </script>
</body>
</html>

